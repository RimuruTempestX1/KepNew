<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <!-- Import map for modules -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js"
        }
      }
    </script>
    <title>Kepler's & Newton's Laws: Solar System Explorer</title>
    <style>
      /* Global Styles */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }
      html,
      body {
        width: 100%;
        height: 100%;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
      }
      body {
        background-color: #050e1a;
        color: #fff;
        touch-action: manipulation;
        position: fixed;
      }
      /* Splash Screen */
      #splash-screen {
        position: fixed;
        width: 100%;
        height: 100%;
        background-color: #050e1a;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        transition: opacity 1.5s ease-out;
      }
      #splash-logo {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: radial-gradient(circle, #ff9500, #ff5e00);
        box-shadow: 0 0 60px rgba(255, 94, 0, 0.6);
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          transform: scale(0.95);
          box-shadow: 0 0 40px rgba(255, 94, 0, 0.5);
        }
        50% {
          transform: scale(1.05);
          box-shadow: 0 0 70px rgba(255, 94, 0, 0.7);
        }
        100% {
          transform: scale(0.95);
          box-shadow: 0 0 40px rgba(255, 94, 0, 0.5);
        }
      }
      .splash-text {
        margin-top: 20px;
        font-size: 24px;
        letter-spacing: 4px;
        text-transform: uppercase;
        opacity: 0;
        animation: fadeIn 2s forwards 0.5s;
        text-align: center;
        padding: 0 15px;
      }
      @keyframes fadeIn {
        to {
          opacity: 1;
        }
      }
      /* Main Container */
      .container {
        width: 100%;
        height: 100vh;
        position: relative;
        overflow: hidden;
      }
      /* Solar System Visualization */
      #solar-system {
        width: 100vw;
        height: 100vh;
        position: absolute;
        top: 0;
        left: 0;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      /* UI Controls Panel */
      #controls {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        z-index: 10;
        background: rgba(0, 10, 30, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        max-height: 40vh;
        overflow-y: auto;
      }
      /* Hide controls by default on mobile */
      @media (max-width: 767px) {
        #controls {
          display: none;
        }
        /* Show toggle button on mobile */
        #toggle-controls {
          display: block;
        }
      }
      #controls h3 {
        margin-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 8px;
        font-size: 16px;
      }
      .control-group {
        margin-bottom: 12px;
      }
      .control-label {
        display: block;
        margin-bottom: 4px;
        font-size: 13px;
        color: #aaa;
      }
      input[type="range"] {
        width: 100%;
        margin-bottom: 10px;
        background: rgba(255, 255, 255, 0.1);
        height: 5px;
        border-radius: 5px;
        -webkit-appearance: none;
        appearance: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: #ff5e00;
        border-radius: 50%;
        cursor: pointer;
      }
      input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        background: #ff5e00;
        border-radius: 50%;
        cursor: pointer;
        border: none;
      }
      /* Info Panel */
      #info-panel {
        position: absolute;
        top: 60px;
        right: 10px;
        width: calc(100% - 20px);
        max-height: 70vh;
        overflow-y: auto;
        background: rgba(0, 10, 30, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transform: translateX(100%);
        transition: transform 0.4s ease;
        z-index: 9;
      }
      #info-panel.active {
        transform: translateX(0);
      }
      .info-header {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      .planet-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 12px;
        background-size: cover;
        background-position: center;
        object-fit: cover;
        overflow: hidden;
      }
      .planet-title {
        font-size: 20px;
        margin: 0;
      }
      .info-content p {
        margin-bottom: 10px;
        line-height: 1.5;
        font-size: 14px;
      }
      .adjust-parameters {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }
      .adjust-parameters label {
        font-size: 13px;
        color: #ccc;
      }
      .adjust-parameters input[type="range"] {
        width: 100%;
        margin: 5px 0 10px;
      }
      .adjust-parameters button,
      #reset-controls {
        background: #ff5e00;
        border: none;
        padding: 10px 15px;
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
        font-size: 14px;
        min-height: 44px;
        width: 100%;
        margin-top: 5px;
      }
      .adjust-parameters button:hover,
      #reset-controls:hover {
        background: #ff9500;
      }
      /* Toggle Controls Button (Mobile) */
      #toggle-controls {
        display: none; /* shown only on mobile via media query */
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 11;
        background: #ff5e00;
        border: none;
        padding: 10px 15px;
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
        font-size: 14px;
      }
      #toggle-controls:hover {
        background: #ff9500;
      }
      /* Close Button for Info Panel */
      .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        font-size: 24px;
        color: white;
        cursor: pointer;
        z-index: 10;
      }
      /* Navigation */
      nav {
        position: absolute;
        top: 10px;
        left: 10px;
        right: 10px;
        z-index: 20;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      nav.lessons {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: rgba(0, 10, 30, 0.9);
        padding: 8px;
        z-index: 1000;
        display: flex;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        white-space: nowrap;
      }
      .nav-button {
        background: rgba(0, 10, 30, 0.8);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 8px;
        padding: 12px 15px;
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-right: 6px;
        cursor: pointer;
        transition: background 0.3s;
        min-height: 44px;
        font-size: 14px;
        display: inline-block;
      }
      .nav-button:hover,
      .nav-button:active {
        background: rgba(0, 20, 60, 0.9);
      }
      /* Lessons Section */
      #kepler-laws {
        display: none;
        position: absolute;
        top: 60px;
        left: 0;
        width: 100vw;
        height: calc(100vh - 60px);
        background: #050e1a;
        z-index: 5;
        padding: 15px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .law-container {
        max-width: 100%;
        margin: 0 auto 30px;
        background: rgba(0, 10, 30, 0.7);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .law-container h2 {
        margin-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 12px;
        font-size: 18px;
      }
      .law-content {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      .law-text {
        flex: 1;
        font-size: 14px;
        line-height: 1.5;
      }
      .law-viz {
        flex: 1;
        min-height: 200px;
        background: rgba(0, 5, 15, 0.5);
        border-radius: 10px;
        position: relative;
        overflow: hidden;
      }
      .loading {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #fff;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
      @keyframes spin {
        0% {
          transform: translate(-50%, -50%) rotate(0deg);
        }
        100% {
          transform: translate(-50%, -50%) rotate(360deg);
        }
      }
      /* Media Queries for devices */
      @media (max-width: 360px) {
        #splash-logo {
          width: 120px;
          height: 120px;
        }
        .splash-text {
          font-size: 18px;
          letter-spacing: 3px;
        }
        #controls h3,
        .planet-title {
          font-size: 16px;
        }
        .nav-button {
          padding: 8px 12px;
          font-size: 13px;
        }
        .control-label,
        .adjust-parameters label,
        .info-content p {
          font-size: 12px;
        }
      }
      @media (min-width: 361px) and (max-width: 767px) {
        #controls {
          max-height: 45vh;
        }
        .nav-button {
          padding: 10px 14px;
        }
        #info-panel {
          max-height: 65vh;
        }
      }
      @media (min-width: 768px) {
        #controls {
          width: 300px;
          left: 20px;
          right: auto;
          max-height: 80vh;
        }
        #info-panel {
          width: 350px;
          right: 20px;
          top: 20px;
        }
        .law-content {
          flex-direction: row;
        }
        nav {
          left: 20px;
          top: 20px;
        }
        .splash-text {
          font-size: 28px;
          letter-spacing: 5px;
        }
        #splash-logo {
          width: 180px;
          height: 180px;
        }
      }
      @supports (padding: max(0px)) {
        nav,
        #controls,
        #info-panel {
          padding-left: max(12px, env(safe-area-inset-left));
          padding-right: max(12px, env(safe-area-inset-right));
        }
        nav.lessons {
          padding-top: max(8px, env(safe-area-inset-top));
        }
        #controls {
          padding-bottom: max(12px, env(safe-area-inset-bottom));
        }
      }
      @supports (-webkit-touch-callout: none) {
        .container,
        #solar-system {
          height: -webkit-fill-available;
        }
      }
      .nav-button,
      #controls,
      #info-panel,
      .control-label {
        -webkit-user-select: none;
        user-select: none;
      }
    </style>
  </head>
  <body>
    <!-- Splash Screen -->
    <div id="splash-screen">
      <div id="splash-logo"></div>
      <div class="splash-text">KepNew Space</div>
    </div>
    <!-- Main Container -->
    <div class="container">
      <!-- Navigation -->
      <nav id="nav">
        <button class="nav-button" id="view-solar-system">Solar System</button>
        <button class="nav-button" id="view-kepler-laws">Lessons</button>
      <!-- Toggle Controls Button (visible on mobile) -->
      <button id="toggle-controls" class ="nav-button">Show Controls</button>
      </nav>
      <!-- Solar System Visualization -->
      <div id="solar-system"></div>
      <!-- Controls Panel -->
      <div id="controls">
        <h3>Controls</h3>
        <div class="control-group">
          <label class="control-label">Time Scale</label>
          <input type="range" id="time-scale" min="0.1" max="10" step="0.1" value="1" />
          <span id="time-value">1x</span>
        </div>
        <div class="control-group">
          <label class="control-label">Global Eccentricity</label>
          <input type="range" id="eccentricity" min="0" max="0.9" step="0.01" value="0.2" />
          <span id="eccentricity-value">0.2</span>
        </div>
        <div class="control-group">
          <label class="control-label">Global Semi-major Axis Multiplier</label>
          <input type="range" id="semi-major" min="0.1" max="2" step="0.1" value="1" />
          <span id="semi-major-value">1x</span>
        </div>
        <div class="control-group">
          <button id="reset-controls">Reset Controls</button>
        </div>
      </div>
      <!-- Info Panel -->
      <div id="info-panel">
        <button class="close-btn">&times;</button>
        <div class="info-header">
          <div class="planet-icon" id="selected-planet-icon"></div>
          <h2 class="planet-title" id="selected-planet-name">Object Name</h2>
        </div>
        <div class="info-content" id="planet-info">
          <!-- Detailed information will be inserted here -->
        </div>
        <div class="adjust-parameters" id="adjust-form" style="display: none;">
          <h3>Adjust Planet Parameters</h3>
          <label>
            Eccentricity: <span id="adjust-ecc-value"></span>
            <input type="range" id="adjust-eccentricity" min="0" max="0.9" step="0.01" />
          </label>
          <label>
            Semi-major Axis Multiplier: <span id="adjust-semi-value"></span>
            <input type="range" id="adjust-semi-major" min="0.5" max="2" step="0.1" value="1" />
          </label>
          <br /><br />
          <button id="reset-adjust">Reset Adjustments</button>
        </div>
      </div>
      <!-- Kepler's Laws Section -->
      <div id="kepler-laws">
        <!-- Newton's Law of Universal Gravitation -->
        <div class="law-container">
          <h2>Newton's Law of Universal Gravitation</h2>
          <div class="law-content">
            <div class="law-text">
              <p>
                Newton discovered that every mass attracts every other mass. This gravitational force is given by:
              </p>
              <p style="text-align:center;"><strong>F = G (m₁ m₂) / r²</strong></p>
              <p>
                In this interactive visualization, tap anywhere on the canvas to freeze/unfreeze the scene. The distance between the masses and the resulting force relationship are indicated.
              </p>
            </div>
            <div class="law-viz" id="newton-law-viz"><div class="loading"></div></div>
          </div>
        </div>
        <!-- Kepler's First Law -->
        <div class="law-container">
          <h2>Kepler's First Law: The Law of Elliptical Orbits</h2>
          <div class="law-content">
            <div class="law-text">
              <p>
                Planets orbit the Sun in ellipses with the Sun at one focus. The ellipse’s shape is defined by its semi‑major axis (a) and eccentricity (e).
              </p>
              <p>
                In this interactive experiment, tap the canvas to freeze the planet’s motion and view its current orbital parameters.
              </p>
            </div>
            <div class="law-viz" id="first-law-viz"><div class="loading"></div></div>
          </div>
        </div>
        <!-- Kepler's Second Law -->
        <div class="law-container">
          <h2>Kepler's Second Law: The Law of Equal Areas</h2>
          <div class="law-content">
            <div class="law-text">
              <p>
                A line joining a planet and the Sun sweeps out equal areas in equal time intervals.
              </p>
              <p>
                In this interactive visualization, tap the red wedge (sector) to freeze the sweep. The computed area is displayed below.
              </p>
            </div>
            <div class="law-viz" id="second-law-viz"><div class="loading"></div></div>
          </div>
        </div>
        <!-- Kepler's Third Law -->
        <div class="law-container">
          <h2>Kepler's Third Law: The Law of Harmonies</h2>
          <div class="law-content">
            <div class="law-text">
              <p>
                The square of a planet's orbital period (T) is proportional to the cube of its orbit's semi‑major axis (a): T² ∝ a³.
              </p>
              <p>
                In this interactive scene, tap to freeze the motion of two planets and view their current period ratio.
              </p>
            </div>
            <div class="law-viz" id="third-law-viz"><div class="loading"></div></div>
          </div>
        </div>
        <!-- Mercury Example -->
        <div class="law-container">
          <h2>Example: Calculating Mercury's Orbital Period</h2>
          <div class="law-content">
            <div class="law-text">
              <p>
                Given Mercury’s distance is 0.4 AU and Earth’s orbital period is 1 year, Kepler’s Third Law yields:
              </p>
              <p style="text-align:center;">Tₑ² / 1³ = Tₘ² / (0.4)³</p>
              <ul>
                <li>(0.4)³ = 0.064</li>
                <li>Tₘ² = 0.064, so Tₘ ≈ 0.253 years (≈92.3 days)</li>
              </ul>
              <p>
                Tap the canvas to freeze Mercury’s orbit and see the computed period overlay relative to Earth.
              </p>
            </div>
            <div class="law-viz" id="kepler-example-viz"><div class="loading"></div></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Script -->
    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js';
      import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/controls/OrbitControls.js';
      import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/loaders/GLTFLoader.js';
      import { EffectComposer } from 'https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/postprocessing/EffectComposer.js';
      import { RenderPass } from 'https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/postprocessing/RenderPass.js';
      import { UnrealBloomPass } from 'https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/postprocessing/UnrealBloomPass.js';
      import { EXRLoader } from 'https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/loaders/EXRLoader.js';

      // Global variables
      let scene, camera, renderer, controls, composer;
      const planetsGlobal = {};
      let selectedPlanetKey = null;
      let asteroidBelt;
      const clickableObjects = [];
      const totalAsteroids = 1;
      const asteroidModels = [];
      const asteroidPaths = [
        "mesh/asteroid.glb",
        "mesh/asteroid2.glb",
        "mesh/asteroid3.glb",
        "mesh/asteroid4.glb"
      ];

      // Model paths and data
      const models = {
        sun: 'mesh/sun.glb',
        mercury: 'mesh/mercury.glb',
        venus: 'mesh/venus.glb',
        earth: 'mesh/earth.glb',
        mars: 'mesh/mars.glb',
        jupiter: 'mesh/jupiter.glb',
        saturn: 'mesh/saturn.glb',
        uranus: 'mesh/uranus.glb',
        neptune: 'mesh/neptune.glb'
      };

      const planetData = {
        mercury: { name: "Mercury", semiMajorAxis: 0.39, eccentricity: 0.206, orbitalPeriod: 88, rotationPeriod: 58.6, description: "Mercury is the smallest and innermost planet.", color: "#b1b1b1" },
        venus:   { name: "Venus", semiMajorAxis: 0.72, eccentricity: 0.007, orbitalPeriod: 225, rotationPeriod: -243, description: "Venus has a runaway greenhouse effect.", color: "#f5deb3" },
        earth:   { name: "Earth", semiMajorAxis: 1.00, eccentricity: 0.017, orbitalPeriod: 365.25, rotationPeriod: 1, description: "Earth supports life with abundant water.", color: "#2a8fbd" },
        mars:    { name: "Mars", semiMajorAxis: 1.52, eccentricity: 0.093, orbitalPeriod: 687, rotationPeriod: 1.03, description: "Mars is the Red Planet.", color: "#d14b28" },
        jupiter: { name: "Jupiter", semiMajorAxis: 5.20, eccentricity: 0.048, orbitalPeriod: 4333, rotationPeriod: 0.41, description: "Jupiter is a gas giant.", color: "#d2b48c" },
        saturn:  { name: "Saturn", semiMajorAxis: 9.58, eccentricity: 0.056, orbitalPeriod: 10759, rotationPeriod: 0.45, description: "Saturn is known for its rings.", color: "#f4a460" },
        uranus:  { name: "Uranus", semiMajorAxis: 19.22, eccentricity: 0.046, orbitalPeriod: 30687, rotationPeriod: -0.72, description: "Uranus rotates sideways.", color: "#7fffd4" },
        neptune: { name: "Neptune", semiMajorAxis: 30.05, eccentricity: 0.010, orbitalPeriod: 60190, rotationPeriod: 0.67, description: "Neptune is a deep blue ice giant.", color: "#4169e1" }
      };

      const sunData = { name: "sun", description: "The Sun powers our solar system.", color: "#ffcc00" };

      const moonsData = {
        earth: [ { name: "moon", orbitRadius: 8, orbitSpeed: 1, scale: 0.2, description: "Earth's Moon influences tides." } ],
        mars: [ { name: "phobos", orbitRadius: 8, orbitSpeed: 1.5, scale: 0.015, description: "Phobos is Mars' larger moon." },
                { name: "deimos", orbitRadius: 10, orbitSpeed: 1, scale: 0.015, description: "Deimos is Mars' smaller moon." } ],
        jupiter: [
            { name: "io", orbitRadius: 12, orbitSpeed: 1.8, scale: 0.001, description: "Io is volcanically active." },
            { name: "europa", orbitRadius: 16, orbitSpeed: 1.6, scale: 0.001, description: "Europa may hide a subsurface ocean." },
            { name: "ganymede", orbitRadius: 20, orbitSpeed: 1.4, scale: 0.001, description: "Ganymede is the largest moon." },
            { name: "callisto", orbitRadius: 24, orbitSpeed: 1.2, scale: 0.001, description: "Callisto is heavily cratered." }
          ],
        saturn: [
            { name: "titan", orbitRadius: 18, orbitSpeed: 1.3, scale: 0.0005, description: "Titan has a thick atmosphere." },
            { name: "rhea", orbitRadius: 22, orbitSpeed: 1.4, scale: 0.0005, description: "Rhea is a mid-sized, cratered moon." }
          ],
        uranus: [
            { name: "titania", orbitRadius: 18, orbitSpeed: 1.5, scale: 0.0007, description: "Titania features deep canyons." },
            { name: "oberon", orbitRadius: 22, orbitSpeed: 1.4, scale: 0.0007, description: "Oberon is heavily cratered." }
          ],
        neptune: [ { name: "triton", orbitRadius: 16, orbitSpeed: 1.6, scale: 0.001, description: "Triton has a retrograde orbit and geysers." } ]
      };

      const DEFAULT_TIME_SCALE = 1;
      const DEFAULT_ECCENTRICITY = 0.2;
      const DEFAULT_SEMI_MAJOR_MULTIPLIER = 1;
      const beltInnerRadius = 100;
      const beltOuterRadius = 110;

      const gltfLoader = new GLTFLoader();

      function preloadAsteroids(callback) {
        let loaded = 0;
        asteroidPaths.forEach(path => {
          gltfLoader.load(path, function(gltf) {
            asteroidModels.push(gltf.scene);
            loaded++;
            if (loaded === asteroidPaths.length) {
              callback();
            }
          });
        });
      }

      function createAsteroidBelt() {
        const group = new THREE.Group();
        const countPerModel = Math.floor(totalAsteroids / asteroidModels.length);
        asteroidModels.forEach(model => {
          let baseMesh;
          model.traverse(child => {
            if(child.isMesh && !baseMesh) baseMesh = child;
          });
          if (!baseMesh) return;
          const geometry = baseMesh.geometry;
          const material = baseMesh.material.clone();
          material.frustumCulled = false;
          const instancedMesh = new THREE.InstancedMesh(geometry, material, countPerModel);
          instancedMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
          const dummy = new THREE.Object3D();
          for(let i = 0; i < countPerModel; i++){
            const theta = Math.random() * Math.PI * 2;
            const radius = beltInnerRadius + Math.random() * (beltOuterRadius - beltInnerRadius);
            dummy.position.set(radius * Math.cos(theta), (Math.random() - 0.5) * 2, radius * Math.sin(theta));
            const scale = 0.002;
            dummy.scale.set(scale, scale, scale);
            dummy.rotation.y = Math.random() * Math.PI * 2;
            dummy.updateMatrix();
            instancedMesh.setMatrixAt(i, dummy.matrix);
          }
          instancedMesh.instanceMatrix.needsUpdate = true;
          instancedMesh.userData = { type: "asteroid" };
          group.add(instancedMesh);
        });
        scene.add(group);
        asteroidBelt = group;
      }

      function initSolarSystem() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById("solar-system").appendChild(renderer.domElement);
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 1;
        controls.maxDistance = 10000;
        controls.rotateSpeed = 1.0;
        if ('ontouchstart' in window) {
          controls.enableZoom = false;
          controls.enablePan = false;
          controls.enableRotate = false;
        }
        camera.position.set(0, 50, 100);
        composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloomParams = { exposure: 1, bloomStrength: 1.5, bloomThreshold: 0.2, bloomRadius: 0.4 };
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), bloomParams.bloomStrength, bloomParams.bloomRadius, bloomParams.bloomThreshold);
        composer.addPass(bloomPass);
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const sunLight = new THREE.PointLight(0xffffff, 1000, 500);
        scene.add(sunLight);
        new EXRLoader().load("mesh/Background.exr", function(texture) {
          texture.mapping = THREE.EquirectangularReflectionMapping;
          texture.encoding = THREE.LinearEncoding;
          scene.background = texture;
        });
        gltfLoader.load(models.sun, function(gltf) {
          const sun = gltf.scene;
          sun.traverse(child => {
            if(child.isMesh){
              child.userData = { ...child.userData, type: "sun" };
              child.matrixAutoUpdate = false;
              clickableObjects.push(child);
            }
          });
          sun.add(sunLight);
          scene.add(sun);
        });
        const orbitScale = 50;
        Object.entries(planetData).forEach(([key, planet]) => {
          gltfLoader.load(models[key], function(gltf) {
            const planetModel = gltf.scene;
            const angle = Math.random() * Math.PI * 2;
            const globalMultiplier = parseFloat(document.getElementById("semi-major").value);
            const a = planet.semiMajorAxis * globalMultiplier * orbitScale;
            const ecc = planet.eccentricity;
            const b = a * Math.sqrt(1 - ecc ** 2);
            planetModel.position.x = a * (Math.cos(angle) - ecc);
            planetModel.position.z = b * Math.sin(angle);
            planetModel.traverse(child => {
              if(child.isMesh){
                child.frustumCulled = true;
                child.matrixAutoUpdate = false;
                child.userData = { ...child.userData, type: "planet", key: key };
                clickableObjects.push(child);
              }
            });
            scene.add(planetModel);
            const orbitPoints = [];
            for(let i = 0; i <= 100; i++){
              const theta = (i / 100) * Math.PI * 2;
              orbitPoints.push(a * (Math.cos(theta) - ecc), 0, b * Math.sin(theta));
            }
            const orbitGeometry = new THREE.BufferGeometry();
            orbitGeometry.setAttribute("position", new THREE.Float32BufferAttribute(orbitPoints, 3));
            const orbitMaterial = new THREE.LineBasicMaterial({ color: 0x444444 });
            const orbitLine = new THREE.Line(orbitGeometry, orbitMaterial);
            orbitLine.frustumCulled = true;
            orbitLine.matrixAutoUpdate = false;
            scene.add(orbitLine);
            let moons = [];
            if(moonsData[key]){
              moonsData[key].forEach(mData => {
                gltfLoader.load(`mesh/${mData.name}.glb`, function(gltf) {
                  const moonModel = gltf.scene;
                  moonModel.name = "moon_" + mData.name;
                  moonModel.userData = { type: "moon", parent: key, name: mData.name, description: mData.description };
                  moonModel.scale.set(mData.scale || 1, mData.scale || 1, mData.scale || 1);
                  moonModel.updateMatrix();
                  const orbitRadius = mData.orbitRadius;
                  const mAngle = Math.random() * Math.PI * 2;
                  moonModel.position.set(Math.cos(mAngle) * orbitRadius, 0, Math.sin(mAngle) * orbitRadius);
                  moonModel.traverse(child => {
                    if(child.isMesh){
                      child.userData = moonModel.userData;
                      child.frustumCulled = true;
                      clickableObjects.push(child);
                    }
                  });
                  planetModel.add(moonModel);
                  const moonOrbitPoints = [];
                  const segments = 64;
                  for(let i = 0; i <= segments; i++){
                    const theta = (i / segments) * Math.PI * 2;
                    moonOrbitPoints.push(Math.cos(theta) * orbitRadius, 0, Math.sin(theta) * orbitRadius);
                  }
                  const moonOrbitGeometry = new THREE.BufferGeometry();
                  moonOrbitGeometry.setAttribute("position", new THREE.Float32BufferAttribute(moonOrbitPoints, 3));
                  const moonOrbitMaterial = new THREE.LineBasicMaterial({ color: 0x888888 });
                  const moonOrbitLine = new THREE.Line(moonOrbitGeometry, moonOrbitMaterial);
                  moonOrbitLine.frustumCulled = true;
                  moonOrbitLine.matrixAutoUpdate = false;
                  planetModel.add(moonOrbitLine);
                  moons.push({ mesh: moonModel, orbitRadius: orbitRadius, angle: mAngle, orbitSpeed: mData.orbitSpeed, orbitLine: moonOrbitLine });
                });
              });
            }
            planetsGlobal[key] = { mesh: planetModel, angle: angle, data: { ...planet, semiMajorMultiplier: 1 }, orbitLine: orbitLine, moons: moons };
          });
        });
        createAsteroidBelt();
        window.addEventListener("resize", function(){
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
          composer.setSize(window.innerWidth, window.innerHeight);
        });

        // Raycaster for detecting interactions
        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        function detectInteraction(clientX, clientY) {
          pointer.x = (clientX / window.innerWidth) * 2 - 1;
          pointer.y = -(clientY / window.innerHeight) * 2 + 1;
          raycaster.setFromCamera(pointer, camera);
          const intersects = raycaster.intersectObjects(clickableObjects, true);
          if(intersects.length > 0){
            const data = intersects[0].object.userData;
            if(data && data.type && data.type !== "asteroid"){
              showObjectInfo(data);
            }
          }
        }

        document.getElementById("solar-system").addEventListener("click", function(event){
          detectInteraction(event.clientX, event.clientY);
        });

        // Custom Mobile Touch Controls
        const solarSystemElem = document.getElementById("solar-system");
        let touchStartTime = 0;
        let isTouching = false;
        let lastTouchX = 0, lastTouchY = 0;
        let lastTouchDistance = null;
        let touchMoveCount = 0;

        solarSystemElem.addEventListener("touchstart", function(event) {
          touchStartTime = Date.now();
          touchMoveCount = 0;
          if(event.touches.length === 1){
            isTouching = true;
            lastTouchX = event.touches[0].clientX;
            lastTouchY = event.touches[0].clientY;
          } else if(event.touches.length === 2){
            isTouching = false;
            lastTouchDistance = getDistance(event.touches[0], event.touches[1]);
          }
          event.preventDefault();
        }, {passive: false});

        solarSystemElem.addEventListener("touchmove", function(event) {
          touchMoveCount++;
          if(event.touches.length === 1 && isTouching){
            let touch = event.touches[0];
            let deltaX = touch.clientX - lastTouchX;
            let deltaY = touch.clientY - lastTouchY;
            const panFactor = 0.1 * (camera.position.z / 100);
            if(Math.abs(deltaX) > 2 || Math.abs(deltaY) > 2) {
              camera.position.x -= deltaX * panFactor;
              camera.position.y += deltaY * panFactor * 0.5;
            }
            lastTouchX = touch.clientX;
            lastTouchY = touch.clientY;
          } else if(event.touches.length === 2){
            let currentDistance = getDistance(event.touches[0], event.touches[1]);
            if(lastTouchDistance){
              let zoomDelta = currentDistance - lastTouchDistance;
              const zoomFactor = 0.1;
              const minDistance = controls.minDistance;
              const maxDistance = controls.maxDistance;
              let newZ = camera.position.z - zoomDelta * zoomFactor;
              newZ = Math.max(minDistance, Math.min(maxDistance, newZ));
              camera.position.z = newZ;
            }
            lastTouchDistance = currentDistance;
          }
          event.preventDefault();
        }, {passive: false});

        solarSystemElem.addEventListener("touchend", function(event) {
          const touchDuration = Date.now() - touchStartTime;
          if(event.touches.length === 0) {
            if(touchDuration < 300 && touchMoveCount < 5){
              const touch = event.changedTouches[0];
              detectInteraction(touch.clientX, touch.clientY);
            }
            isTouching = false;
            lastTouchDistance = null;
          }
          event.preventDefault();
        }, {passive: false});

        // Mobile Detection and Optimizations
        const isMobile = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        function applyMobileOptimizations() {
          if (isMobile) {
            document.body.classList.add('mobile-device');
            renderer.setPixelRatio(window.devicePixelRatio > 1 ? 1.5 : 1);
            camera.position.set(0, 70, 150);
            composer.removePass(bloomPass);
            showMobileInstructions();
            totalAsteroids = Math.min(totalAsteroids, 1000);
            scene.traverse(object => {
              if (object.isMesh) {
                object.frustumCulled = true;
              }
            });
            // Hide controls initially on mobile
            document.getElementById("controls").style.display = "none";
          }
        }

        function showMobileInstructions() {
          const mobileInstructions = document.createElement('div');
          mobileInstructions.id = 'mobile-instructions';
          mobileInstructions.innerHTML = `
            <div class="instructions-panel">
              <h3>Mobile Controls</h3>
              <ul>
                <li>One finger: Pan the view</li>
                <li>Two fingers: Zoom in/out</li>
                <li>Quick tap: Select object</li>
              </ul>
              <button id="close-instructions">Got it!</button>
            </div>
          `;
          document.body.appendChild(mobileInstructions);
          const style = document.createElement('style');
          style.textContent = `
            #mobile-instructions {
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.7);
              z-index: 10000;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .instructions-panel {
              background: rgba(20, 30, 50, 0.95);
              padding: 20px;
              border-radius: 15px;
              max-width: 85%;
              text-align: center;
              box-shadow: 0 5px 25px rgba(0,0,0,0.5);
              border: 1px solid rgba(255,255,255,0.1);
            }
            .instructions-panel h3 {
              margin-top: 0;
              color: #4a90e2;
            }
            .instructions-panel ul {
              text-align: left;
              margin: 15px 0;
              padding-left: 20px;
            }
            #close-instructions {
              margin-top: 10px;
              width: 100%;
            }
          `;
          document.head.appendChild(style);
          document.getElementById('close-instructions').addEventListener('click', function() {
            document.body.removeChild(mobileInstructions);
            localStorage.setItem('mobileInstructionsShown', 'true');
          });
          if (localStorage.getItem('mobileInstructionsShown') === 'true') {
            document.body.removeChild(mobileInstructions);
          }
        }

        function enableDeviceOrientationControls() {
          if (isMobile && typeof DeviceOrientationEvent !== 'undefined') {
            const deviceOrientationToggle = document.createElement('button');
            deviceOrientationToggle.id = 'orientation-toggle';
            deviceOrientationToggle.textContent = 'Enable Gyroscope';
            deviceOrientationToggle.style.position = 'fixed';
            deviceOrientationToggle.style.bottom = '80px';
            deviceOrientationToggle.style.right = '10px';
            deviceOrientationToggle.style.zIndex = '1000';
            document.body.appendChild(deviceOrientationToggle);
            let gyroEnabled = false;
            deviceOrientationToggle.addEventListener('click', function() {
              if (!gyroEnabled) {
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                  DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                      if (permissionState === 'granted') {
                        enableGyroscope();
                        this.textContent = 'Disable Gyroscope';
                        gyroEnabled = true;
                      }
                    })
                    .catch(console.error);
                } else {
                  enableGyroscope();
                  this.textContent = 'Disable Gyroscope';
                  gyroEnabled = true;
                }
              } else {
                disableGyroscope();
                this.textContent = 'Enable Gyroscope';
                gyroEnabled = false;
              }
            });
            let deviceOrientation = null;
            function enableGyroscope() {
              deviceOrientation = new THREE.DeviceOrientationControls(camera);
              window.addEventListener('deviceorientation', updateOrientation);
            }
            function disableGyroscope() {
              if (deviceOrientation) {
                window.removeEventListener('deviceorientation', updateOrientation);
                deviceOrientation.disconnect();
                deviceOrientation = null;
              }
            }
            function updateOrientation() {
              if (deviceOrientation) {
                deviceOrientation.update();
              }
            }
          }
        }

        function addPerformanceModeToggle() {
          if (isMobile) {
            const performanceToggle = document.createElement('button');
            performanceToggle.id = 'performance-toggle';
            performanceToggle.textContent = 'High Performance Mode';
            performanceToggle.style.position = 'fixed';
            performanceToggle.style.bottom = '130px';
            performanceToggle.style.right = '10px';
            performanceToggle.style.zIndex = '1000';
            document.body.appendChild(performanceToggle);
            let highPerformance = false;
            performanceToggle.addEventListener('click', function() {
              highPerformance = !highPerformance;
              if (highPerformance) {
                if (asteroidBelt) {
                  asteroidBelt.visible = false;
                }
                renderer.shadowMap.enabled = false;
                scene.traverse(object => {
                  if (object.isLine) {
                    object.visible = false;
                  }
                });
                this.textContent = 'Standard Mode';
              } else {
                if (asteroidBelt) {
                  asteroidBelt.visible = true;
                }
                renderer.shadowMap.enabled = true;
                scene.traverse(object => {
                  if (object.isLine) {
                    object.visible = true;
                  }
                });
                this.textContent = 'High Performance Mode';
              }
            });
          }
        }

        // Toggle Controls Button for Mobile
        const toggleControlsBtn = document.getElementById("toggle-controls");
        toggleControlsBtn.addEventListener("click", function(){
          const controlsPanel = document.getElementById("controls");
          if(controlsPanel.style.display === "none" || controlsPanel.style.display === ""){
            controlsPanel.style.display = "block";
            this.textContent = "Hide Controls";
          } else {
            controlsPanel.style.display = "none";
            this.textContent = "Show Controls";
          }
        });

        document.addEventListener("DOMContentLoaded", function() {
          setTimeout(function() {
            const splashScreen = document.getElementById("splash-screen");
            splashScreen.style.opacity = "0";
            setTimeout(function() {
              splashScreen.style.display = "none";
              preloadAsteroids(initSolarSystem);
            }, 1500);
          }, 2500);
        });

        function getDistance(t1, t2) {
          let dx = t2.clientX - t1.clientX;
          let dy = t2.clientY - t1.clientY;
          return Math.sqrt(dx * dx + dy * dy);
        }

        // WASD Continuous Movement
        const keysPressed = {};
        document.addEventListener("keydown", function(event) {
          keysPressed[event.key.toLowerCase()] = true;
        });
        document.addEventListener("keyup", function(event) {
          keysPressed[event.key.toLowerCase()] = false;
        });

        const speedFactor = 5;
        function animate(){
          requestAnimationFrame(animate);
          controls.update();
          const moveSpeed = 0.5;
          if(keysPressed['w']) { camera.position.z -= moveSpeed; }
          if(keysPressed['s']) { camera.position.z += moveSpeed; }
          if(keysPressed['a']) { camera.position.x -= moveSpeed; }
          if(keysPressed['d']) { camera.position.x += moveSpeed; }
          const timeScale = parseFloat(document.getElementById("time-scale").value) * 0.05;
          const orbitScale = 50;
          const globalMultiplier = parseFloat(document.getElementById("semi-major").value);
          Object.entries(planetsGlobal).forEach(([key, planet]) => {
            const a = planet.data.semiMajorAxis * planet.data.semiMajorMultiplier * globalMultiplier * orbitScale;
            const ecc = planet.data.eccentricity;
            const b = a * Math.sqrt(1 - ecc ** 2);
            const orbitalSpeed = timeScale * speedFactor / Math.sqrt(a ** 3);
            planet.angle += orbitalSpeed;
            if(planet.mesh){
              planet.mesh.position.x = a * (Math.cos(planet.angle) - ecc);
              planet.mesh.position.z = b * Math.sin(planet.angle);
              if(planet.moons && planet.moons.length > 0){
                planet.moons.forEach(m => {
                  m.angle += orbitalSpeed * m.orbitSpeed;
                  m.mesh.position.set(Math.cos(m.angle) * m.orbitRadius, 0, Math.sin(m.angle) * m.orbitRadius);
                });
              }
            }
          });
          if(asteroidBelt){ asteroidBelt.rotation.y += 0.0005; }
          composer.render();
        }
        animate();
      }

      function updateOrbitLine(planetKey) {
        const planetObj = planetsGlobal[planetKey];
        scene.remove(planetObj.orbitLine);
        const orbitScale = 50;
        const globalMultiplier = parseFloat(document.getElementById("semi-major").value);
        const a = planetObj.data.semiMajorAxis * planetObj.data.semiMajorMultiplier * globalMultiplier * orbitScale;
        const ecc = planetObj.data.eccentricity;
        const b = a * Math.sqrt(1 - ecc ** 2);
        const orbitPoints = [];
        for(let i = 0; i <= 100; i++){
          const theta = (i / 100) * Math.PI * 2;
          orbitPoints.push(a * (Math.cos(theta) - ecc), 0, b * Math.sin(theta));
        }
        const orbitGeometry = new THREE.BufferGeometry();
        orbitGeometry.setAttribute("position", new THREE.Float32BufferAttribute(orbitPoints, 3));
        const orbitMaterial = new THREE.LineBasicMaterial({ color: 0x444444 });
        const newOrbitLine = new THREE.Line(orbitGeometry, orbitMaterial);
        newOrbitLine.frustumCulled = true;
        newOrbitLine.matrixAutoUpdate = false;
        scene.add(newOrbitLine);
        planetObj.orbitLine = newOrbitLine;
      }

      function showObjectInfo(userData) {
        if(userData.type === "asteroid") return;
        const infoPanel = document.getElementById("info-panel");
        const nameEl = document.getElementById("selected-planet-name");
        const iconEl = document.getElementById("selected-planet-icon");
        const infoContent = document.getElementById("planet-info");
        const adjustForm = document.getElementById("adjust-form");
        const nav = document.getElementById("nav");
        // Hide navigation and controls on mobile when info panel is shown
        if(window.innerWidth < 768) {
          nav.style.display = "none";
          document.getElementById("controls").style.display = "none";
          document.getElementById("toggle-controls").textContent = "Show Controls";
        }
        let html = "";
        if(userData.type === "planet"){
          const planet = planetData[userData.key];
          selectedPlanetKey = userData.key;
          nameEl.textContent = planet.name;
          iconEl.style.backgroundImage = `url('texture/${planet.name.toLowerCase()}.png')`;
          html += `<p>${planet.description}</p>`;
          html += `<p><strong>Semi-major Axis (default):</strong> ${planet.semiMajorAxis} AU</p>`;
          html += `<p><strong>Eccentricity (default):</strong> ${planet.eccentricity}</p>`;
          html += `<p><strong>Orbital Period:</strong> ${planet.orbitalPeriod} Earth days</p>`;
          html += `<p><strong>Rotation Period:</strong> ${Math.abs(planet.rotationPeriod)} Earth days${planet.rotationPeriod < 0 ? " (retrograde)" : ""}</p>`;
          if(moonsData[userData.key]){
            html += `<p><strong>Moons:</strong> ${moonsData[userData.key].map(m => m.name).join(", ")}</p>`;
          }
          adjustForm.style.display = "block";
          document.getElementById("adjust-eccentricity").value = planet.eccentricity;
          document.getElementById("adjust-semi-major").value = 1;
          document.getElementById("adjust-ecc-value").textContent = planet.eccentricity;
          document.getElementById("adjust-semi-value").textContent = "1x";
        } else if(userData.type === "moon"){
          const parent = planetData[userData.parent];
          nameEl.textContent = "Moon: " + userData.name + " of " + parent.name;
          iconEl.style.backgroundImage = `url('texture/${userData.name.toLowerCase()}.png')`;
          html += `<p>${userData.description || "Detailed information about this moon is not available."}</p>`;
          adjustForm.style.display = "none";
        } else if(userData.type === "sun"){
          nameEl.textContent = sunData.name;
          iconEl.style.backgroundImage = `url('texture/sun.png')`;
          html += `<p>${sunData.description}</p>`;
          adjustForm.style.display = "none";
        }
        infoContent.innerHTML = html;
        infoPanel.classList.add("active");
      }

      // Updated close button event handler (works on both desktop and mobile)
      document.querySelector(".close-btn").addEventListener("click", function(){
          document.getElementById("info-panel").classList.remove("active");
          // On mobile, re-show navigation if needed
          if(window.innerWidth < 768) {
            document.getElementById("nav").style.display = "block";
          }
      });

      // Lesson Visualizations
      let lawVisualizationsInitialized = false;
      function initLawVisualizations(){
        if(lawVisualizationsInitialized) return;
        lawVisualizationsInitialized = true;
        initNewtonViz();
        initFirstLawViz();
        initSecondLawViz();
        initThirdLawViz();
        initExampleViz();
      }

      function createMiniScene(containerId){
        const container = document.getElementById(containerId);
        const loaderEl = container.querySelector('.loading');
        if(loaderEl) container.removeChild(loaderEl);
        const width = container.clientWidth;
        const height = Math.max(container.clientHeight, 250);
        const miniRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        miniRenderer.setSize(width, height);
        container.appendChild(miniRenderer.domElement);
        const miniScene = new THREE.Scene();
        const miniCamera = new THREE.PerspectiveCamera(50, width/height, 0.1, 1000);
        miniCamera.position.set(0, 0, 10);
        const miniControls = new OrbitControls(miniCamera, miniRenderer.domElement);
        miniControls.enableDamping = true;
        miniControls.dampingFactor = 0.05;
        miniControls.minDistance = 2;
        miniControls.maxDistance = 50;
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        miniScene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(10, 10, 10);
        miniScene.add(directionalLight);
        function onResize(){
          const w = container.clientWidth;
          const h = Math.max(container.clientHeight, 250);
          miniCamera.aspect = w/h;
          miniCamera.updateProjectionMatrix();
          miniRenderer.setSize(w, h);
        }
        window.addEventListener('resize', onResize);
        function animateMini(){
          requestAnimationFrame(animateMini);
          miniControls.update();
          miniRenderer.render(miniScene, miniCamera);
        }
        animateMini();
        return { miniScene, miniCamera, miniRenderer };
      }

      function createTextSprite(text){
        const canvas = document.createElement('canvas');
        canvas.width = 256;
        canvas.height = 64;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.font = '24px Arial';
        ctx.fillText(text, 10, 40);
        return new THREE.Sprite(new THREE.SpriteMaterial({ map: new THREE.CanvasTexture(canvas) }));
      }

      // Newton's Law Visualization
      function initNewtonViz(){
        const { miniScene, miniRenderer } = createMiniScene("newton-law-viz");
        const sphereGeom = new THREE.SphereGeometry(0.5, 32, 32);
        const mat1 = new THREE.MeshStandardMaterial({ color: 0x00ccff });
        const mat2 = new THREE.MeshStandardMaterial({ color: 0xffcc00 });
        const mass1 = new THREE.Mesh(sphereGeom, mat1);
        mass1.position.set(-2, 0, 0);
        miniScene.add(mass1);
        const mass2 = new THREE.Mesh(sphereGeom, mat2);
        mass2.position.set(2, 0, 0);
        miniScene.add(mass2);
        const arrow = new THREE.ArrowHelper(new THREE.Vector3(1, 0, 0), new THREE.Vector3(-2, 0, 0), 4, 0xff0000);
        miniScene.add(arrow);
        const distanceSprite = createTextSprite("Distance: 4 units");
        distanceSprite.scale.set(4, 1, 1);
        distanceSprite.position.set(0, -1.5, 0);
        miniScene.add(distanceSprite);
        const forceSprite = createTextSprite("Force ∝ 1/r²");
        forceSprite.scale.set(4, 1, 1);
        forceSprite.position.set(0, 2.5, 0);
        miniScene.add(forceSprite);
        let freeze = false;
        miniRenderer.domElement.style.cursor = "pointer";
        miniRenderer.domElement.addEventListener("click", function(){
          freeze = !freeze;
          if(freeze){
            const dist = mass1.position.distanceTo(mass2.position).toFixed(2);
            const ctx = distanceSprite.material.map.image.getContext('2d');
            ctx.clearRect(0, 0, 256, 64);
            ctx.fillStyle = "white";
            ctx.font = "24px Arial";
            ctx.fillText("Distance: " + dist + " units", 10, 40);
            distanceSprite.material.map.needsUpdate = true;
          }
        });
      }

      // Kepler's First Law Visualization
      function initFirstLawViz(){
        const { miniScene, miniRenderer } = createMiniScene("first-law-viz");
        const starGeom = new THREE.SphereGeometry(0.4, 32, 32);
        const starMat = new THREE.MeshStandardMaterial({ color: 0xffdd00 });
        const star = new THREE.Mesh(starGeom, starMat);
        star.position.set(-1, 0, 0);
        miniScene.add(star);
        const planetGeom = new THREE.SphereGeometry(0.2, 16, 16);
        const planetMat = new THREE.MeshStandardMaterial({ color: 0x00aaff });
        const planet = new THREE.Mesh(planetGeom, planetMat);
        miniScene.add(planet);
        const a = 2, e = 0.6, b = a * Math.sqrt(1 - e * e);
        const points = [];
        for(let i = 0; i <= 100; i++){
          const theta = (i / 100) * Math.PI * 2;
          points.push(new THREE.Vector3(a * (Math.cos(theta) - e), b * Math.sin(theta), 0));
        }
        const ellipse = new THREE.Line(new THREE.BufferGeometry().setFromPoints(points), new THREE.LineBasicMaterial({ color: 0xffffff }));
        miniScene.add(ellipse);
        const paramsSprite = createTextSprite("a = 2, e = 0.6");
        paramsSprite.scale.set(3, 1, 1);
        paramsSprite.position.set(0, -2.5, 0);
        miniScene.add(paramsSprite);
        let angle = 0;
        let freeze = false;
        miniRenderer.domElement.style.cursor = "pointer";
        miniRenderer.domElement.addEventListener("click", function(){
          freeze = !freeze;
          if(freeze){
            const x = a * (Math.cos(angle) - e).toFixed(2);
            const y = (b * Math.sin(angle)).toFixed(2);
            const ctx = paramsSprite.material.map.image.getContext('2d');
            ctx.clearRect(0, 0, 256, 64);
            ctx.fillStyle = "white";
            ctx.font = "24px Arial";
            ctx.fillText(`a = 2, e = 0.6 | pos: (${x}, ${y})`, 10, 40);
            paramsSprite.material.map.needsUpdate = true;
          }
        });
        function animateOrbit(){
          requestAnimationFrame(animateOrbit);
          if(!freeze){ angle += 0.01; }
          planet.position.set(a * (Math.cos(angle) - e), b * Math.sin(angle), 0);
        }
        animateOrbit();
      }

      // Kepler's Second Law Visualization
      function initSecondLawViz(){
        const { miniScene, miniRenderer } = createMiniScene("second-law-viz");
        const starGeom = new THREE.SphereGeometry(0.4, 32, 32);
        const starMat = new THREE.MeshStandardMaterial({ color: 0xffdd00 });
        const star = new THREE.Mesh(starGeom, starMat);
        miniScene.add(star);
        const planetGeom = new THREE.SphereGeometry(0.2, 16, 16);
        const planetMat = new THREE.MeshStandardMaterial({ color: 0x00aaff });
        const planet = new THREE.Mesh(planetGeom, planetMat);
        miniScene.add(planet);
        const a = 3, e = 0.5, b = a * Math.sqrt(1 - e * e);
        const sectorGeom = new THREE.BufferGeometry();
        const sectorMat = new THREE.MeshBasicMaterial({ color: 0xff0000, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
        const sectorMesh = new THREE.Mesh(sectorGeom, sectorMat);
        miniScene.add(sectorMesh);
        const areaSprite = createTextSprite("Area: calculating...");
        areaSprite.scale.set(3, 1, 1);
        areaSprite.position.set(0, -3, 0);
        miniScene.add(areaSprite);
        let angle = 0;
        let freeze = false;
        let freezeAngle = 0;
        miniRenderer.domElement.style.cursor = "pointer";
        miniRenderer.domElement.addEventListener("click", function(){
          freeze = !freeze;
          if(freeze){ freezeAngle = angle; }
        });
        function updateSector(){
          const segments = 30;
          let vertices = [0, 0, 0];
          for(let i = 0; i <= segments; i++){
            const t = freeze ? (freezeAngle * i / segments) : (angle * i / segments);
            vertices.push(a * (Math.cos(t) - e), b * Math.sin(t), 0);
          }
          const vertexArray = new Float32Array(vertices);
          sectorGeom.setAttribute('position', new THREE.BufferAttribute(vertexArray, 3));
          sectorGeom.computeVertexNormals();
          sectorGeom.setDrawRange(0, vertices.length / 3);
          if(freeze){
            const frac = freezeAngle / (2 * Math.PI);
            const area = frac * Math.PI * a * b;
            const ctx = areaSprite.material.map.image.getContext('2d');
            ctx.clearRect(0, 0, 256, 64);
            ctx.fillStyle = "white";
            ctx.font = "24px Arial";
            ctx.fillText("Area ≈ " + area.toFixed(2) + " sq. units", 10, 40);
            areaSprite.material.map.needsUpdate = true;
          }
        }
        function animateOrbit(){
          requestAnimationFrame(animateOrbit);
          if(!freeze){ angle += 0.02; }
          planet.position.set(a * (Math.cos(angle) - e), b * Math.sin(angle), 0);
          updateSector();
        }
        animateOrbit();
      }

      // Kepler's Third Law Visualization
      function initThirdLawViz(){
        const { miniScene, miniRenderer } = createMiniScene("third-law-viz");
        const starGeom = new THREE.SphereGeometry(0.4, 32, 32);
        const starMat = new THREE.MeshStandardMaterial({ color: 0xffdd00 });
        const star = new THREE.Mesh(starGeom, starMat);
        miniScene.add(star);
        const planet1 = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshStandardMaterial({ color: 0x00aaff }));
        const planet2 = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshStandardMaterial({ color: 0xff88aa }));
        miniScene.add(planet1);
        miniScene.add(planet2);
        function makeCircle(r){
          const pts = [];
          for(let i = 0; i < 64; i++){
            const theta = (i / 64) * Math.PI * 2;
            pts.push(new THREE.Vector3(r * Math.cos(theta), r * Math.sin(theta), 0));
          }
          pts.push(new THREE.Vector3(r, 0, 0));
          return new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), new THREE.LineBasicMaterial({ color: 0xffffff }));
        }
        const orbit1Radius = 2, orbit2Radius = 3.5;
        miniScene.add(makeCircle(orbit1Radius));
        miniScene.add(makeCircle(orbit2Radius));
        let angle1 = 0, angle2 = 0;
        const ratio = Math.pow((orbit2Radius / orbit1Radius), 1.5);
        const speed1 = 0.03, speed2 = speed1 / ratio;
        const ratioSprite = createTextSprite("T² ∝ a³");
        ratioSprite.scale.set(3, 1, 1);
        ratioSprite.position.set(0, -3, 0);
        miniScene.add(ratioSprite);
        let freeze = false;
        miniRenderer.domElement.style.cursor = "pointer";
        miniRenderer.domElement.addEventListener("click", function(){
          freeze = !freeze;
          if(freeze){
            const periodRatio = (1 / speed2 / (1 / speed1)).toFixed(2);
            const ctx = ratioSprite.material.map.image.getContext('2d');
            ctx.clearRect(0, 0, 256, 64);
            ctx.fillStyle = "white";
            ctx.font = "24px Arial";
            ctx.fillText("Period Ratio: " + periodRatio, 10, 40);
            ratioSprite.material.map.needsUpdate = true;
          }
        });
        function animateOrbit(){
          requestAnimationFrame(animateOrbit);
          if(!freeze){
            angle1 += speed1;
            angle2 += speed2;
          }
          planet1.position.set(orbit1Radius * Math.cos(angle1), orbit1Radius * Math.sin(angle1), 0);
          planet2.position.set(orbit2Radius * Math.cos(angle2), orbit2Radius * Math.sin(angle2), 0);
        }
        animateOrbit();
      }

      // Mercury Example Visualization
      function initExampleViz(){
        const { miniScene, miniRenderer } = createMiniScene("kepler-example-viz");
        const star = new THREE.Mesh(new THREE.SphereGeometry(0.4, 32, 32), new THREE.MeshStandardMaterial({ color: 0xffdd00 }));
        miniScene.add(star);
        const mercury = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshStandardMaterial({ color: 0xb1b1b1 }));
        miniScene.add(mercury);
        const rMercury = 2;
        function makeCircleLine(r, color){
          const pts = [];
          for(let i = 0; i < 64; i++){
            const theta = (i / 64) * Math.PI * 2;
            pts.push(new THREE.Vector3(r * Math.cos(theta), r * Math.sin(theta), 0));
          }
          pts.push(new THREE.Vector3(r, 0, 0));
          return new THREE.Line(new THREE.BufferGeometry().setFromPoints(pts), new THREE.LineBasicMaterial({ color }));
        }
        miniScene.add(makeCircleLine(rMercury, 0xaaaaaa));
        const labelSprite = createTextSprite("Mercury: T ≈ 0.253 yrs");
        labelSprite.scale.set(4, 1, 1);
        labelSprite.position.set(0, 2.5, 0);
        miniScene.add(labelSprite);
        let angle = 0;
        let freeze = false;
        miniRenderer.domElement.style.cursor = "pointer";
        miniRenderer.domElement.addEventListener("click", function(){
          freeze = !freeze;
          if(freeze){
            const ctx = labelSprite.material.map.image.getContext('2d');
            ctx.clearRect(0, 0, 256, 64);
            ctx.fillStyle = "white";
            ctx.font = "24px Arial";
            ctx.fillText("Mercury: T ≈ 0.253 yrs", 10, 40);
            labelSprite.material.map.needsUpdate = true;
          }
        });
        function animateMercury(){
          requestAnimationFrame(animateMercury);
          if(!freeze){ angle += 0.08; }
          mercury.position.set(rMercury * Math.cos(angle), rMercury * Math.sin(angle), 0);
        }
        animateMercury();
      }
    </script>
  </body>
</html>
